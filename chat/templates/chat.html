<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Website Chat</title>
<style>
body {margin:0; background:#1e2128; color:#e6e6e6; font-family:Arial;}
#container {display:flex; height:100vh;}
#chatArea {flex:1; padding:15px;}
#sidebar {width:180px; background:#14161c; border-left:1px solid #3a3f4a; padding:10px;}
h2 {color:#7aa2f7; margin-top:0;}
input, button {background:#2a2f3a; color:#fff; border:1px solid #3a3f4a; padding:5px; margin:2px;}
button:hover {background:#3a3f4a; cursor:pointer;}
#chatBox {height:65vh; background:#111; border:1px solid #3a3f4a; overflow-y:auto; padding:6px; white-space:pre-wrap;}
.user {padding:2px; font-size:14px;}
.message {margin-bottom:4px;}
.timestamp {color:#888; font-size:12px;}
.username {color:#7aa2f7; font-weight:bold;}
.msgid {color:#555; font-size:10px; margin-left:5px; cursor:help;}
.deleteBtn {color:#f55; background:none; border:none; cursor:pointer; margin-left:5px;}
/* ===== BRIGHT BLUE BACK BUTTON ===== */
#back-button {
    margin: 10px 0;
    padding: 8px 14px;
    font-size: 14px;
    border-radius: 6px;
    border: none;
    background-color: #00aaff;   /* bright blue */
    color: #fff;                 /* white text */
    font-weight: bold;
    box-shadow: 0 4px #0088cc;   /* subtle shadow for depth */
}

#back-button:hover {
    background-color: #0099dd;   /* slightly darker blue on hover */
    cursor: pointer;
}

#back-button:active {
    background-color: #0088cc;   /* darker on click */
    box-shadow: 0 2px #006699;
    transform: translateY(2px);
}

</style>
</head>
<body>
<button id="back-button" onclick="window.location.href='https://flights-gadgets-oct-excited.trycloudflare.com'">‚Üê Back</button>
<div id="container">
<div id="chatArea">
<h2>Website Chat</h2>

<div id="login">
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <button id="loginBtn">Login</button>
    <button id="registerBtn">Create Account</button>
    <div id="error"></div>
</div>

<div id="chat" style="display:none;">
    <div>
        <button onclick="switchRoom('public')">Public</button>
        <button onclick="newRoom()">New Room</button>
        <input id="roomCode" placeholder="Enter Room Code" style="width:100px; margin-left:5px;">
        <button onclick="joinRoom()">Join</button>
        <span id="roomLabel"></span>
        <label id="showIDsLabel" style="margin-left:10px; display:none;">
            <input type="checkbox" id="showIDs"> Show Message IDs
        </label>
        <label id="showDeleteLabel" style="margin-left:10px; display:none;">
            <input type="checkbox" id="showDelete"> Show Quick Delete Buttons
        </label>
    </div>
    <div id="chatBox"></div>
    <input id="message" style="width:70%" placeholder="Message or command" maxlength="1000">
    <button id="sendBtn">Send</button>
    <button id="logoutBtn">Logout</button>
</div>
</div>

<div id="sidebar">
    <b>Online Users</b>
    <div id="userList"></div>
</div>
</div>

<script>
let user="", room="public", lastLen=0;
let isAdmin=false;

const usernameInput=document.getElementById("username");
const passwordInput=document.getElementById("password");
const loginDiv=document.getElementById("login");
const chatDiv=document.getElementById("chat");
const errorDiv=document.getElementById("error");
const chatBox=document.getElementById("chatBox");
const messageInput=document.getElementById("message");
const userList=document.getElementById("userList");
const roomLabel=document.getElementById("roomLabel");
const loginBtn=document.getElementById("loginBtn");
const registerBtn=document.getElementById("registerBtn");
const sendBtn=document.getElementById("sendBtn");
const logoutBtn=document.getElementById("logoutBtn");
const showIDsCheckbox=document.getElementById("showIDs");
const showIDsLabel=document.getElementById("showIDsLabel");
const showDeleteCheckbox=document.getElementById("showDelete");
const showDeleteLabel=document.getElementById("showDeleteLabel");

// ---------------- Login / Logout ----------------
function login(){
    user=usernameInput.value.trim();
    const pass=passwordInput.value.trim();
    if(!user||!pass){ errorDiv.textContent="Enter username and password"; return; }
    
    fetch("/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:user,password:pass})})
    .then(r=>r.json()).then(d=>{
        if(d.status==="ok"){ showChat(); start(); checkAdmin(); } else errorDiv.textContent="Login failed";
    });
}

function logout(){ fetch("/logout").then(()=>location.reload()); }
function showChat(){ loginDiv.style.display="none"; chatDiv.style.display="block"; logoutBtn.style.display="inline"; }

// ---------------- Register ----------------
function register(){
    const u=usernameInput.value.trim();
    const p=passwordInput.value.trim();
    if(!u||!p){ errorDiv.textContent="Enter username/password"; return; }
    fetch("/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u,password:p})})
    .then(r=>{ errorDiv.textContent = r.ok?"Account created":"Username exists"; });
}

// ---------------- Chat ----------------
function renderMessages(d){
    chatBox.innerHTML = d.map(m=>{
        let parts = m.text.split("|");
        if(parts.length<2) return "";
        let ts = parts[0];
        let rest = parts[1];
        let uname = rest.split(":")[0];
        let msg = rest.split(":").slice(1).join(":").trim();
        let html = `<div class="message"><span class="timestamp">${ts}</span> <span class="username">${uname}:</span> ${msg}`;
        if(isAdmin){
            if(showIDsCheckbox.checked) html += ` <span class="msgid">${m.id}</span>`;
            if(showDeleteCheckbox.checked) html += ` <button class="deleteBtn" onclick="deleteMsg('${m.id}')">X</button>`;
        }
        html += `</div>`;
        return html;
    }).join("");
}

function load(){
    fetch(`/messages?room=${room}`)
        .then(r=>r.json())
        .then(d=>{
            // Save scroll info
            const isAtBottom = chatBox.scrollTop + chatBox.clientHeight >= chatBox.scrollHeight - 5;
            const oldScrollTop = chatBox.scrollTop;

            renderMessages(d);

            // Restore scroll
            if(isAtBottom){
                chatBox.scrollTop = chatBox.scrollHeight;
            } else {
                chatBox.scrollTop = oldScrollTop;
            }

            roomLabel.textContent = room==="public"?"":"Room "+room;
        });
}

function send(){ 
    const msg = messageInput.value.trim(); 
    if(!msg) return; 

    fetch(msg.startsWith("/") ? "/command" : "/send", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({message: msg, cmd: msg, room: room})
    })
    .then(r => {
        if(r.status === 402) {           // Muted
            errorDiv.textContent = "You are muted. You cannot send messages.";
        }
        else if(r.status === 403) {      // Banned
            errorDiv.textContent = "You are banned. Access denied.";
        }
        else if(r.status === 429) {      // Rate limit
            errorDiv.textContent = "Rate limit exceeded. Please wait a few seconds.";
        }
        else if(r.ok) {
            errorDiv.textContent = "";   // Clear any previous error
        }
    });

    messageInput.value = ""; 
}

function deleteMsg(id){ fetch("/command",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cmd:"/delete "+id})}).then(()=>load()); }
function loadUsers(){ fetch("/users").then(r=>r.json()).then(d=>userList.innerHTML=d.map(u=>`<div class="user">${u}</div>`).join("")); }
function switchRoom(r){ room=r; lastLen=0; load(); }
function newRoom(){ fetch("/room/new").then(r=>r.text()).then(switchRoom); }

// ---------------- Event Listeners ----------------
loginBtn.onclick=login;
registerBtn.onclick=register;
sendBtn.onclick=send;
logoutBtn.onclick=logout;
messageInput.addEventListener("keydown",e=>{if(e.key==="Enter"){send();e.preventDefault();}});
showIDsCheckbox.addEventListener("change",()=>load());
showDeleteCheckbox.addEventListener("change",()=>load());

// ---------------- Auto-login ----------------
fetch("/whoami").then(r=>r.json()).then(d=>{ if(d.user){ user=d.user; showChat(); start(); checkAdmin(); } });

// ---------------- Admin check ----------------
function checkAdmin(){
    fetch("/command",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cmd:"/checkrole"})})
    .then(r=>r.json()).then(res=>{
        if(res.role==="admin"){ isAdmin=true; showIDsLabel.style.display="inline"; showDeleteLabel.style.display="inline"; }
        else{ isAdmin=false; showIDsLabel.style.display="none"; showDeleteLabel.style.display="none"; }
    });
}
//--Join Room--
function joinRoom() {
    const code = document.getElementById("roomCode").value.trim();
    if(!code) return;

    fetch("/room/join", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({room: code})
    })
    .then(r => {
        if(r.ok) {
            room = code;
            lastLen = 0;
            load();
        } else {
            alert("Room does not exist or you are banned.");
        }
    });
}

// ---------------- Start fetching ----------------
function start(){ load(); setInterval(load,1000); setInterval(loadUsers,3000); setInterval(()=>fetch("/ping",{method:"POST"}),5000); }
</script>
</body>
</html>
